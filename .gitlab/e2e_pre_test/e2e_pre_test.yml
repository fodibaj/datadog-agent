# e2e_pre_test.yml
# Contains jobs which runs e2e tests to validate the new-e2e framework.
e2e_pre_test:
  rules:
    - !reference [.on_e2e_changes_or_manual]
  stage: e2e_pre_test
  extends: .new_e2e_template
  script:
    - inv -e new-e2e-tests.run --targets ./test-infra-definition --junit-tar "junit-${CI_JOB_NAME}.tgz" ${EXTRA_PARAMS}
  after_script:
    - set +x
    - export DATADOG_API_KEY=$(aws ssm get-parameter --region us-east-1 --name ci.datadog-agent.datadog_api_key_org2 --with-decryption --query "Parameter.Value" --out text)
    - set -x
    - set +e
    - for f in junit*-e2e-*.tgz; do inv -e junit-upload --tgz-path "$f"; done
  variables:
    TEAM: "agent-platform"
